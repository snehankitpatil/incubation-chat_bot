<!doctype html>
<html>

<head>
  <title>Chatbot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body {
      background-color: rgb(150, 40, 40);
      margin: 0;
      padding: 0;
      height: 100vh;
    }

    #glassBot {
      position: fixed;
      bottom: 20px;
      right: 20px;
      font-family: Arial, sans-serif;
      z-index: 99999;
    }

    #glassBot-btn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      font-size: 22px;
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(12px);
      box-shadow: 0 8px 22px rgba(0, 0, 0, 0.35);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    #glassBot-badge {
      position: absolute;
      top: -4px;
      right: -4px;
      background: #ff3b3b;
      color: white;
      font-size: 11px;
      font-weight: bold;
      min-width: 18px;
      height: 18px;
      padding: 0 5px;
      border-radius: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: pulseBadge 1.8s infinite;
    }

    @keyframes pulseBadge {
      50% {
        transform: scale(1.15);
      }
    }

    #glassBot-box {
      display: none;
      width: 360px;
      height: 470px;
      border-radius: 18px;
      background: rgba(20, 20, 20, 0.55);
      backdrop-filter: blur(16px);
      box-shadow: 0 12px 35px rgba(0, 0, 0, 0.4);
      overflow: hidden;
      margin-bottom: 12px;
      color: white;
    }

    #glassBot-head {
      padding: 12px 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(0, 0, 0, 0.35);
      cursor: grab;
      user-select: none;
    }

    #glassBot-head:active {
      cursor: grabbing;
    }

    #glassBot-tabs {
      display: flex;
      background: rgba(255, 255, 255, 0.08);
      border-bottom: 1px solid rgba(255, 255, 255, 0.16);
    }

    .glassBot-tab {
      flex: 1;
      padding: 10px;
      cursor: pointer;
      text-align: center;
      font-weight: bold;
      font-size: 13px;
      opacity: 0.8;
    }

    .glassBot-active {
      background: rgba(255, 255, 255, 0.13);
      border-bottom: 2px solid rgba(13, 110, 253, 0.9);
      opacity: 1;
    }

    #glassBot-faq,
    #glassBot-chat {
      height: 320px;
      overflow-y: auto;
      padding: 12px;
    }

    .glassBot-faq-item {
      padding: 11px 12px;
      border-radius: 12px;
      margin-bottom: 10px;
      cursor: pointer;
      background: rgba(255, 255, 255, 0.09);
      border: 1px solid rgba(255, 255, 255, 0.12);
    }

    .glassBot-msg {
      padding: 10px;
      border-radius: 14px;
      margin: 8px 0;
      width: fit-content;
      max-width: 78%;
      font-size: 14px;
      animation: pop 0.15s ease-in;
      word-wrap: break-word;
    }

    @keyframes pop {
      from {
        transform: scale(0.95);
        opacity: 0.6;
      }

      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    .glassBot-user {
      margin-left: auto;
      background: rgba(13, 110, 253, 0.75);
    }

    .glassBot-bot {
      background: rgba(255, 255, 255, 0.14);
    }

    #glassBot-typing {
      padding: 6px 12px;
      font-size: 12px;
      opacity: 0.8;
      display: none;
    }

    #glassBot-input {
      display: none;
      border-top: 1px solid rgba(255, 255, 255, 0.14);
      background: rgba(0, 0, 0, 0.2);
    }

    #glassBot-input input {
      flex: 1;
      padding: 12px;
      border: none;
      outline: none;
      background: transparent;
      color: white;
    }

    #glassBot-input button {
      border: none;
      padding: 0 14px;
      cursor: pointer;
      background: rgba(13, 110, 253, 0.85);
      color: white;
    }

    .aws-title {
      font-weight: bold;
      font-size: 17px;
      margin-bottom: 8px;
    }

    .aws-section {
      font-weight: bold;
      margin-top: 12px;
      margin-bottom: 6px;
    }

    .aws-bullet {
      margin-left: 8px;
      margin-bottom: 10px;
      line-height: 1.6;
    }

    .glassBot-bot a {
      color: #4da6ff;
      text-decoration: none;
      font-weight: 600;
    }

    .glassBot-bot a:hover {
      text-decoration: underline;
    }
  </style>
</head>

<body>
  <div id="glassBot">
    <div id="glassBot-box">
      <div id="glassBot-head">
        <b>RPF Support Assistant</b>
        <div style="display: flex; gap: 12px">
          <span id="glassBot-clear">ðŸ—‘</span>
          <span id="glassBot-close">âœ–</span>
        </div>
      </div>

      <div id="glassBot-tabs">
        <div class="glassBot-tab glassBot-active" id="glassTabFAQ">FAQ</div>
        <div class="glassBot-tab" id="glassTabCHAT">Chat</div>
      </div>

      <div id="glassBot-faq">
        <div class="glassBot-faq-item">ðŸ“Œ What is SPPU Research Park Foundation (SPPU-RPF)?</div>
        <div class="glassBot-faq-item">ðŸ•’ What is Startup Incubation Facility?</div>
        <div class="glassBot-faq-item">ðŸ“ž What is Consultancy Services?</div>
        <div class="glassBot-faq-item">ðŸ’³ What is Co-location?</div>
        <div class="glassBot-faq-item">âž– What is Building Incubation Pipeline? </div>
        <div class="glassBot-faq-item">ðŸ“¦ What are Research Collaborations?</div>
      </div>

      <div id="glassBot-chat" style="display: none"></div>
      <div id="glassBot-typing">Bot is typing...</div>

      <div id="glassBot-input">
        <input id="glassBot-text" placeholder="Type your message..." />
        <button id="glassBot-send">âž¤</button>
      </div>
    </div>

    <button id="glassBot-btn">ðŸ’¬</button>
  </div>

  <script>
    const btn = document.getElementById("glassBot-btn");
    const box = document.getElementById("glassBot-box");
    const closeBtn = document.getElementById("glassBot-close");
    const clearBtn = document.getElementById("glassBot-clear");

    const tabFAQ = document.getElementById("glassTabFAQ");
    const tabCHAT = document.getElementById("glassTabCHAT");

    const faqSection = document.getElementById("glassBot-faq");
    const chatSection = document.getElementById("glassBot-chat");

    const inputWrap = document.getElementById("glassBot-input");
    const inputText = document.getElementById("glassBot-text");
    const sendBtn = document.getElementById("glassBot-send");
    const typing = document.getElementById("glassBot-typing");

    /* ================= AWS STYLE FORMATTER ================= */

    function formatAWS(text) {

      // Normalize bullets
      text = text.replace(/ â€¢ /g, "\nâ€¢ ");
      text = text.replace(/\* /g, "â€¢ ");

      // Extract Title (# Title)
      text = text.replace(/^# (.*$)/gm, "<div class='aws-title'>$1</div>");

      // Section headers
      text = text.replace(/Key Points:/g, "<div class='aws-section'>Key Benefits:</div>");
      text = text.replace(/Facilities \/ Support \/ Details:/g, "<div class='aws-section'>Facilities / Support:</div>");

      // Bullet formatting
      text = text.replace(/â€¢ (.*?)(?=\n|$)/g, "<div class='aws-bullet'>â€¢ $1</div>");

      // Line breaks
      text = text.replace(/\n/g, "");

      return text;
    }

    function typeBotMessage(text, speed = 10) {

      const formatted = formatAWS(text);

      const div = document.createElement("div");
      div.className = "glassBot-msg glassBot-bot";
      chatSection.appendChild(div);

      let i = 0;

      function typingEffect() {
        if (i < formatted.length) {
          div.innerHTML = formatted.substring(0, i);
          i++;
          chatSection.scrollTop = chatSection.scrollHeight;
          setTimeout(typingEffect, speed);
        }
      }

      typingEffect();
    }

    /* ================= BACKEND CALL ================= */

    async function sendToBackend(message) {
      try {
        const response = await fetch("http://127.0.0.1:5000/ask", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ question: message }),
        });
        const data = await response.json();
        return data.answer || "ðŸ¤– I couldn't find an answer.";
      } catch {
        return "âŒ Server error.";
      }
    }

    function addUserMessage(text) {
      const div = document.createElement("div");
      div.className = "glassBot-msg glassBot-user";
      div.innerHTML = text;
      chatSection.appendChild(div);
    }

    async function handleSend(text) {
      if (!text.trim()) return;

      addUserMessage(text);
      inputText.value = "";
      typing.style.display = "block";

      const reply = await sendToBackend(text);

      typing.style.display = "none";
      typeBotMessage(reply);   // âœ… IMPORTANT
    }

    async function clearChat() {
      chatSection.innerHTML = "";
      try {
        await fetch("http://127.0.0.1:5000/reset", { method: "POST" });
      } catch { }
      typeBotMessage("ðŸ—‘ Chat cleared! ðŸ‘‹ Hello! Ask me anything.");
    }

    /* ================= UI HANDLERS ================= */

    btn.onclick = () => {
      box.style.display = box.style.display === "block" ? "none" : "block";
    };

    closeBtn.onclick = () => (box.style.display = "none");
    clearBtn.onclick = clearChat;

    tabFAQ.onclick = () => {
      faqSection.style.display = "block";
      chatSection.style.display = "none";
      inputWrap.style.display = "none";
    };

    tabCHAT.onclick = () => {
      faqSection.style.display = "none";
      chatSection.style.display = "block";
      inputWrap.style.display = "flex";
    };

    document.querySelectorAll(".glassBot-faq-item")
      .forEach((i) => (i.onclick = () => handleSend(i.textContent)));

    sendBtn.onclick = () => handleSend(inputText.value);

    inputText.addEventListener("keypress", (e) => {
      if (e.key === "Enter") handleSend(inputText.value);
    });
  </script>
</body>

</html>